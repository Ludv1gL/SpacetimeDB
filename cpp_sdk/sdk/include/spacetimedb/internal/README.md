# SpacetimeDB C++ SDK Internal API

This directory contains the internal implementation of the SpacetimeDB C++ SDK, matching the design of the C# SDK.

## Overview

The Internal API provides:
- **Module Definition Management**: Automatic generation of module definitions using autogenerated types
- **Type Registration**: Type-safe registration system for tables and reducers
- **FFI Wrappers**: Safe wrappers around the SpacetimeDB ABI
- **Table Operations**: Type-safe CRUD operations on tables
- **Reducer System**: Framework for implementing reducers with proper serialization

## Directory Structure

- `autogen/` - Autogenerated types from Rust definitions (RawModuleDefV9, RawTableDefV9, etc.)
- `Module.h/cpp` - Main module management and registration
- `ITable.h` - Table interface and implementation helpers
- `IReducer.h` - Reducer interface 
- `FFI.h/cpp` - Foreign Function Interface definitions

## Key Components

### 1. Module Registration

The `Module` class is a singleton that manages:
- Table registration
- Reducer registration
- Type registration
- Module description generation
- Reducer invocation

### 2. Autogenerated Types

All module definition types are generated from the Rust codebase:
- `RawModuleDefV9` - Main module definition
- `RawTableDefV9` - Table definitions
- `RawReducerDefV9` - Reducer definitions
- `TableAccess`, `TableType`, etc. - Enums and supporting types

### 3. Table Implementation

Tables are implemented by:
1. Defining a row type with BSATN serialization
2. Creating a view class that inherits from `ITableView<View, Row>`
3. Implementing required methods (MakeTableDesc, ReadGenFields)
4. Using provided helpers (DoCount, DoIter, DoInsert, DoDelete)

### 4. Reducer Implementation

Reducers are implemented by:
1. Creating a class that inherits from `IReducer`
2. Implementing `MakeReducerDef` to describe the reducer
3. Implementing `Invoke` to handle the reducer logic

## Usage Example

```cpp
// Define row type
struct Person {
    uint32_t id;
    std::string name;
    uint8_t age;
    
    void bsatn_serialize(SpacetimeDb::bsatn::Writer& writer) const;
    void bsatn_deserialize(SpacetimeDb::bsatn::Reader& reader);
};

// Define table view
class PersonTableView : public ITableView<PersonTableView, Person> {
    // Implementation...
};

// Register in module initialization
SpacetimeDb::Internal::Module::RegisterTable<Person, PersonTableView>();
```

## Migration from Old API

See `MIGRATION_GUIDE.md` for detailed steps on migrating from the manual module definition approach to this new Internal API.

## Future Improvements

- Automatic BSATN serialization generation
- Macro-based table/reducer definitions
- Query builder API
- Index management