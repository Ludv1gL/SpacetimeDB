# SpacetimeDB C++ Module Examples

This directory contains working examples of SpacetimeDB C++ modules using the SpacetimeDB C++ Module Library. The examples demonstrate tables, reducers, logging, and the full range of C++ standard library features available in SpacetimeDB modules.

## Quick Start

The fastest way to build and test a working C++ module:

```bash
# Build the canonical example (lib_fixed_working.cpp)
emcmake cmake -B build
cmake --build build

# Publish it to SpacetimeDB
spacetime start  # if not already running
spacetime publish --bin-path build/lib_fixed_working.wasm my-cpp-module

# Test the module
spacetime call my-cpp-module init_db
spacetime call my-cpp-module insert_one_u8 42
spacetime sql my-cpp-module "SELECT * FROM one_u8"
spacetime logs my-cpp-module
```

## Examples

### ðŸ“‹ lib_fixed_working.cpp (Canonical Example)
**Status: âœ… Fully Working**

The primary example demonstrating all core features:
- **X-Macro Table System**: Clean table definitions using `SPACETIMEDB_TABLES_LIST`
- **Multiple Tables**: Both public and private tables
- **Multiple Reducers**: Various parameter types and complexity levels
- **Enhanced Logging**: INFO/DEBUG/TRACE levels with file/line information
- **Performance Timing**: Automatic LogStopwatch timing spans
- **C++ Standard Library**: Full std::string, std::vector support

```cpp
#define SPACETIMEDB_TABLES_LIST \
    X(OneU8, one_u8, true) \
    X(OneU8, another_u8, false)

#include <spacetimedb/spacetimedb.h>

struct OneU8 { uint8_t n; };

SPACETIMEDB_REDUCER(insert_one_u8, ReducerContext ctx, uint8_t n) {
    OneU8 row{n};
    ctx.db->one_u8().insert(row);
}
```

### ðŸ“‹ lib_standalone_working.cpp
**Status: âœ… Working Alternative**

Alternative implementation without X-Macros, showing:
- Direct table registration
- Complex struct types (id, name, age)
- Multiple field types (uint32_t, std::string, uint8_t)

### ðŸ“‹ lib_truly_standalone.cpp  
**Status: âœ… Minimal Example**

Minimal module without C++ standard library:
- No std::string or std::vector dependencies
- Direct WASM exports
- Useful for understanding the underlying ABI

## Building

### Prerequisites
- **Emscripten SDK** with activated environment (`source emsdk_env.sh`)
- **CMake 3.20+**
- **C++20 compiler**
- **SpacetimeDB CLI**

### Build Commands

```bash
# Build canonical example
emcmake cmake -B build
cmake --build build

# Build specific module
emcmake cmake -B build -DMODULE_SOURCE=src/lib_standalone_working.cpp
cmake --build build

# Build without C++ stdlib (for minimal modules)
emcmake cmake -B build -DMODULE_SOURCE=src/lib_truly_standalone.cpp -DLINK_LIBRARY=OFF
cmake --build build

# Custom output name
emcmake cmake -B build -DOUTPUT_NAME=my_custom_module
cmake --build build
```

### Release Build
```bash
emcmake cmake -B build -DCMAKE_BUILD_TYPE=Release
cmake --build build
```

## Testing Your Module

After building, test your module with SpacetimeDB:

```bash
# 1. Start SpacetimeDB
spacetime start

# 2. Publish module
spacetime publish --bin-path build/lib_fixed_working.wasm test-module

# 3. Check schema
spacetime describe test-module --json

# 4. Test reducers
spacetime call test-module init_db
spacetime call test-module insert_one_u8 123
spacetime call test-module insert_with_offset 10 20

# 5. Query data
spacetime sql test-module "SELECT * FROM one_u8"

# 6. Monitor logs
spacetime logs test-module -f
```

## Features Demonstrated

### âœ… Core Features (Working)
- **Table Registration**: X-Macro and direct registration patterns
- **Reducer Definitions**: 0-3 parameter reducers with various types
- **Data Types**: uint8_t, uint32_t, std::string
- **BSATN Serialization**: Automatic struct serialization
- **Enhanced Logging**: Multi-level logging with context information
- **Performance Timing**: LogStopwatch for microsecond-precision timing
- **Memory Management**: Full C++ stdlib support via WASI shims

### âœ… Table Operations (Working)
- Table creation (public/private)
- Row insertion
- Data querying via SQL
- Multiple table support

### âœ… Advanced Features (Working)
- Enhanced ReducerContext with database access
- Automatic table accessor generation
- Complex parameter parsing
- Error handling and logging

## Architecture

### WASI Shims Approach
To enable C++ standard library in WebAssembly modules:
- **WASI shims** provide minimal implementations of system calls
- **stdout/stderr** redirected through SpacetimeDB's console_log
- **No WASI imports** in final WASM (maintains security model)
- **Full C++ stdlib** including std::string, std::vector, std::algorithm

### Module Library Integration
- **CMake build system** with automatic SpacetimeDB root detection
- **Static library compilation** for consistent builds
- **Emscripten toolchain** with optimized WASM flags
- **Header-only components** for maximum compatibility

### Generated Code Integration
- **Autogenerated headers** (.g.h files) for BSATN types
- **Code regeneration** via `cargo run --example regen-cpp-moduledef`
- **Type-safe bindings** for SpacetimeDB core types

## Troubleshooting

### Common Issues

**Module won't publish:**
- Ensure you're using `LINK_LIBRARY=ON` for modules using std::string/std::vector
- Check that WASI shims are properly linked
- Verify Emscripten environment is activated

**BSATN errors:**
- Regenerate autogen headers if needed
- Ensure struct fields match registered field descriptors

**Runtime errors:**
- Check `spacetime logs your-module` for detailed error information
- Verify reducer parameter types match call arguments

### Getting Help
- Check SpacetimeDB documentation
- Review working examples in this directory
- Use `spacetime describe` to debug module schema issues

## Development Workflow

1. **Create** your module source file in `src/`
2. **Build** with CMake targeting your source file
3. **Publish** to local SpacetimeDB instance
4. **Test** with spacetime CLI commands
5. **Debug** using logs and describe commands
6. **Iterate** based on results

The lib_fixed_working.cpp example provides a complete template for most SpacetimeDB module use cases.