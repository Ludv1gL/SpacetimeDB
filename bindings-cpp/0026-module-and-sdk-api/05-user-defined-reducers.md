# Module and SDK API: User-Defined Reducers

The syntax for reducer definition annotations is defined in the [macro design proposal (in review)](https://github.com/clockworklabs/SpacetimeDBPrivate/blob/centril/proposals/spacetimedb-macro/proposals/0009-spacetimedb-macro.md).

## `ReducerContext` argument

As described in [01: `DbConnection`](./01-db-connection.md), each reducer must declare a first argument of type `&ReducerContext`. Previous versions of SpacetimeDB made this argument optional and by-value.

## The `ReducerContext` type

TODO: update `ReducerContext` for Tyler's Identity Proposal. In particular, nix `caller_identity` and `caller_address` in favor of `auth: AuthCtx` (or `AuthInfo` ?) which has fields `id`, `issuer` and possibly `connection`.

`ReducerContext` has the following user-facing fields or properties:

```rust
#[non_exhaustive]
pub struct ReducerContext {
    /// As described in the `DbConnection` section.
    pub db: Local,

    /// The time at which the reducer was invoked.
    ///
    /// Should be a language-appropriate timestamp type,
    /// i.e. `DateTimeOffset` in C# or `Date` in TypeScript.
    pub timestamp: SystemTime,

    /// The `Identity` of the SpacetimeDB actor which invoked the reducer.
    pub caller_identity: Identity,

    /// The `Address` of the SpacetimeDB actor which invoked the reducer.
    pub caller_address: Option<Address>,
}
```

Note that field names and types are chosen to be consistent with [the `EventContext` type in clients](./03-sdk-callbacks.md#the-eventcontext-type).

`ReducerContext` may have additional fields or properties provided they are hidden, private or documented as non-user-facing. Future work may define additional user-facing fields or properties.

## Reducer error returns in Rust

Prior to this proposal, reducers were permitted to return unit `()` (incl. with the no-return shorthand), or `Result<(), E> where E: std::fmt::Debug`. Using the `Debug` trait for formatting errors is not idiomatic Rust; [the Rust documentation for the deprecated `std::error::Error::description` method](https://doc.rust-lang.org/std/error/trait.Error.html#method.description) encourages using [`ToString::to_string`](https://doc.rust-lang.org/std/string/trait.ToString.html). `ToString` usually uses the same printed format as `std::fmt::Display` for human-readable output (but can be manually implemented with whatever format the programmer desires). Using `std::fmt::Display` rather than `ToString` has (very minor) performance benefits, since one can format a `&'static str` without a heap allocation or copy. We propose that in Rust, reducers will return either unit or `Result<(), E> where E: std::fmt::Display`.

Note that, while `std::error::Error` is attractive as a trait bound for errors, `String` does not implement `Error`. We consider it a requirement that `Result<(), String>` be an acceptable reducer return type, and so opt for the less-restrictive `std::fmt::Display`.

## Reducer exceptions in C#

In C#, any exceptions from a reducer will be caught and converted to string via the standard `ToString()` method that exists on all objects.

Unlike in Rust, the return type of a reducer is `void` regardless of whether it throws an exception or not.

## Client codegen: invoking reducers and registering reducer callbacks

[01: `DbConnection`: Reducer codegen interface](./01-db-connection.md#reducer-codegen-interface) defines the user-facing interface and a potential internal implementation for registering reducer callbacks. The below is non-normative.

For a reducer named `foo` with arguments `A0, A1, A2... An`, a method is generated for the autogenerated `RemoteReducers` type (either intrinsically or via an extension) named `foo` (case-converted) with arguments `A0, A1, A2... An` which sends an invocation request to the remote module. This method fails if the connection is not active. A callback `on_foo` (case-converted) with arguments `&EventContext, &A0, &A1, &A2... &An` is generated for the autogenerated `RemoteReducers` type (either intrinsically or via an extension) to run whenever the client is notified that the remote module ran the reducer.

## Reserved reducer names

We reserve all reducer names beginning with two underscores `__`, and with `on` or `On`. Double-underscore reducer names are used internally to implement built-in reducers, and `on`/`On` are used in SDK codegen for reducer callbacks.

Attempting to define a reducer with a name that matches these patterns will cause an error at macro-expand time. Implementors are also encouraged to signal an error at publish time if a module circumvents the bindings library and manually constructs a `ModuleDef` containing one of these names in a reserved position.
